import React, { useState, useEffect } from "react";
import {
  ExternalLink,
  Newspaper,
  Star, // ë¶ë§ˆí¬ ì•„ì´ì½˜
  RefreshCw,
  ThumbsUp, // UP íˆ¬í‘œ ì•„ì´ì½˜
  ThumbsDown // DOWN íˆ¬í‘œ ì•„ì´ì½˜
} from "lucide-react";

// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, query, where, onSnapshot, addDoc, deleteDoc, doc, getDocs } from 'firebase/firestore';

// NOTE: This is a placeholder component for shadcn-ui Alert.
const Alert = ({ variant, children }) => (
  <div className={`p-4 rounded-lg my-4 ${variant === 'destructive' ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-blue-100 text-blue-700 border border-blue-300'}`}>
    {children}
  </div>
);

const AlertTitle = ({ children }) => <h5 className="font-bold text-lg mb-1">{children}</h5>;
const AlertDescription = ({ children }) => <p className="text-sm">{children}</p>;

// NOTE: This is a placeholder component for shadcn-ui Card.
const Card = ({ children, className }) => (
  <div className={`bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200 ${className}`}>
    {children}
  </div>
);

const CardContent = ({ children }) => <div className="p-4">{children}</div>;

const ITNewsApp = () => {
  const [newsData, setNewsData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [latestDate, setLatestDate] = useState("");
  const [activeTab, setActiveTab] = useState("recommended"); 
  
  // Firebase States
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [bookmarkedNewsIds, setBookmarkedNewsIds] = useState(new Set()); // ë¶ë§ˆí¬ëœ ë‰´ìŠ¤ ID ì§‘í•©

  // New states for AI insights votes and comments
  const [aiInsights, setAiInsights] = useState({}); // { newsId: "insight text" }
  const [loadingInsight, setLoadingInsight] = useState({}); // { newsId: boolean }
  const [aiInsightMetrics, setAiInsightMetrics] = useState({}); // { newsId: { upvotes: number, downvotes: number } }
  const [aiInsightComments, setAiInsightComments] = useState([]); // All AI insight comments from Firestore

  // State to manage AI rebuttal generation loading
  const [isGeneratingAiReply, setIsGeneratingAiReply] = useState(false);

  // Google Sheets ì„¤ì • (ì‚¬ìš©ì ì œê³µ ê°’)
  const SHEET_ID = "1UFE_q1cuaa4WrgATcO6MlvZOgq1zKkU_IAHrJzxPU7U";
  const SHEET_NAME = "news";
  const API_KEY = "AIzaSyDIig_uUt8grXOehM3JyI_sabFBh3EuTS8"; // ì‚¬ìš©ì ì œê³µ API í‚¤

  // Gemini API í‚¤ (ì‚¬ìš©ì ì œê³µ ê°’)
  const GEMINI_API_KEY = "AIzaSyDIig_uUt8grXOehM3JyI_sabFBh3EuTS8";
  
  // Firebase ì´ˆê¸°í™” ë° ì¸ì¦
  useEffect(() => {
    // Canvas í™˜ê²½ì—ì„œ ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const authInstance = getAuth(app);

      setDb(firestore);
      setAuth(authInstance);

      // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
      const unsubscribeAuth = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          // __initial_auth_tokenì´ ìˆìœ¼ë©´ ì»¤ìŠ¤í…€ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸, ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸
          if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(authInstance, __initial_auth_token);
          } else {
            await signInAnonymously(authInstance);
          }
          setUserId(authInstance.currentUser?.uid || crypto.randomUUID()); // ìµëª… ë¡œê·¸ì¸ í›„ userId ì„¤ì •
        }
      });

      return () => unsubscribeAuth(); // í´ë¦°ì—…
    } catch (e) {
      console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì‹¤íŒ¨:", e);
      setError("ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }, []); // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰

  // Google Sheetsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const fetchNewsFromGoogleSheets = async () => {
    setLoading(true);
    setError("");
    
    try {
      if (!API_KEY || API_KEY === "YOUR_GOOGLE_SHEETS_API_KEY") { 
        console.log("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
        throw new Error("Google Sheets API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
      
      const encodedSheetName = encodeURIComponent(SHEET_NAME);
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodedSheetName}?key=${API_KEY}`;
      
      const response = await fetch(url);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Google Sheets API ì˜¤ë¥˜: ${response.status} - ${errorText}`);
      }
      
      const data = await response.json();
      const rows = data.values;
      
      if (!rows || rows.length === 0) {
        throw new Error("Google Sheetsì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
      
      // ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ì´ë¯€ë¡œ ì œì™¸
      const headers = rows[0];
      const dataRows = rows.slice(1);
      
      // ë°ì´í„° íŒŒì‹± (ê¸°ì‚¬ì œëª©-í‚¤ì›Œë“œ-ì–¸ë¡ ì‚¬-íƒœê·¸-ê¸°ì‚¬URL-ë‚ ì§œ-ìš”ì•½-ì¢‹ì•„ìš”)
      const parsedNews = dataRows.map((row, index) => ({
        title: row[0] || "",
        keyword: row[1] || "",
        source: row[2] || "",
        tags: row[3] || "", // íƒœê·¸ ì •ë³´
        url: row[4] || "",
        date: row[5] || "", // ë‚ ì§œ ì •ë³´
        summary: row[6] || "", // ìš”ì•½ ì •ë³´
        likes: parseInt(row[7]) || 0, // ì¢‹ì•„ìš” ìˆ˜ê°€ ìˆë‹¤ë©´
        id: index // ê³ ìœ  ID
      })).filter(news => news.title && news.keyword); // ë¹ˆ ë°ì´í„° í•„í„°ë§
      
      setNewsData(parsedNews);
      
      // ê°€ì¥ ìµœì‹  ë‚ ì§œë¥¼ ì¶”ì¶œ
      if (parsedNews.length > 0) {
        const latest = parsedNews.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date;
        setLatestDate(latest);
      }
      
    } catch (err) {
      console.error("Google Sheets ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", err);
      
      // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì‚¬ìš©
      const simulatedData = [
        {
          title: "ë„¤ì´ë²„, AI ê²€ìƒ‰ ì„œë¹„ìŠ¤ ëŒ€í­ ê°œì„ ... ì •í™•ë„ 30% í–¥ìƒ",
          keyword: "ë„¤ì´ë²„",
          source: "ITì¡°ì„ ",
          tags: "#AI #ê²€ìƒ‰ #ê¸°ìˆ í˜ì‹  #ì¶”ì²œ", // 'ì¶”ì²œ' íƒœê·¸ ì¶”ê°€
          url: "https://example.com/news1",
          date: "2025-08-01",
          summary: "ë„¤ì´ë²„ê°€ ìì²´ ê°œë°œí•œ AI ê¸°ìˆ ì„ ì ìš©í•˜ì—¬ ê²€ìƒ‰ ì •í™•ë„ë¥¼ í¬ê²Œ ê°œì„ í–ˆìœ¼ë©°, ì‚¬ìš©ì ë§Œì¡±ë„ê°€ í¬ê²Œ í–¥ìƒë  ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.",
          likes: 12,
          id: 0
        },
        {
          title: "í† ìŠ¤, íˆ¬ì í”Œë«í¼ 'í† ìŠ¤ì¦ê¶Œ' ì›” ê±°ë˜ì•¡ 10ì¡°ì› ëŒíŒŒ",
          keyword: "í† ìŠ¤",
          source: "ë§¤ì¼ê²½ì œ",
          tags: "#í•€í…Œí¬ #íˆ¬ì #ê±°ë˜ì•¡",
          url: "https://example.com/news2",
          date: "2025-07-31",
          summary: "í† ìŠ¤ì¦ê¶Œì´ ì›” ê±°ë˜ì•¡ 10ì¡°ì›ì„ ëŒíŒŒí•˜ë©° í•€í…Œí¬ ì‹œì¥ì˜ ìƒˆë¡œìš´ ê°•ìë¡œ ë– ì˜¬ëìŠµë‹ˆë‹¤.",
          likes: 8,
          id: 1
        },
        {
          title: "ë‹¹ê·¼ë§ˆì¼“, ì§€ì—­ ìƒê¶Œ í™œì„±í™” í”„ë¡œì íŠ¸ ì‹œì‘... ì†Œìƒê³µì¸ ì§€ì›",
          keyword: "ë‹¹ê·¼ë§ˆì¼“",
          source: "í•œêµ­ê²½ì œ",
          tags: "#ì§€ì—­ìƒê¶Œ #ì†Œìƒê³µì¸ #ì§€ì›ì‚¬ì—… #ì¶”ì²œ", // 'ì¶”ì²œ' íƒœê·¸ ì¶”ê°€
          url: "https://example.com/news3",
          date: "2025-07-31",
          summary: "ë‹¹ê·¼ë§ˆì¼“ì´ ì§€ì—­ ì†Œìƒê³µì¸ì„ ìœ„í•œ ì¢…í•© ì§€ì› í”„ë¡œê·¸ë¨ì„ ëŸ°ì¹­í•˜ë©°, ì˜¨ì˜¤í”„ë¼ì¸ ì—°ê³„ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ì§€ì—­ê²½ì œ í™œì„±í™”ì— ë‚˜ì„°ìŠµë‹ˆë‹¤.",
          likes: 15,
          id: 2
        },
        {
          title: "ì¿ íŒ¡, ë¬¼ë¥˜ ë¡œë´‡ ë„ì…ìœ¼ë¡œ ë°°ì†¡ ì†ë„ 20% ë‹¨ì¶•",
          keyword: "ì¿ íŒ¡",
          source: "ë””ì§€í„¸íƒ€ì„ìŠ¤",
          tags: "#ë¬¼ë¥˜ #ë¡œë´‡ #ë°°ì†¡",
          url: "https://example.com/news4",
          date: "2025-07-30",
          summary: "ì¿ íŒ¡ì´ ë¬¼ë¥˜ì„¼í„°ì— ì²¨ë‹¨ ë¡œë´‡ì„ ë„ì…í•˜ì—¬ ë°°ì†¡ ì²˜ë¦¬ ì†ë„ë¥¼ íšê¸°ì ìœ¼ë¡œ ê°œì„ í–ˆìŠµë‹ˆë‹¤.",
          likes: 6,
          id: 3
        },
        {
          title: "ë°°ë¯¼, ë°°ë‹¬ë£Œ ë¬´ë£Œ ì„œë¹„ìŠ¤ í™•ëŒ€... ì „êµ­ ì£¼ìš” ë„ì‹œë¡œ í™•ì¥",
          keyword: "ë°°ë¯¼",
          source: "ì „ìì‹ ë¬¸",
          tags: "#ë°°ë‹¬ #ë¬´ë£Œì„œë¹„ìŠ¤ #í™•ì¥ #ì¶”ì²œ", // 'ì¶”ì²œ' íƒœê·¸ ì¶”ê°€
          url: "https://example.com/news5",
          date: "2025-07-30",
          summary: "ë°°ë‹¬ì˜ë¯¼ì¡±ì´ ë°°ë‹¬ë£Œ ë¬´ë£Œ ì„œë¹„ìŠ¤ë¥¼ ì „êµ­ ì£¼ìš” ë„ì‹œë¡œ í™•ëŒ€í•˜ë©°, ì†Œë¹„ì ë¶€ë‹´ì„ ì¤„ì´ê³  ì‹œì¥ ì ìœ ìœ¨ í™•ëŒ€ì— ë‚˜ì„°ìŠµë‹ˆë‹¤.",
          likes: 20,
          id: 4
        },
        {
          title: "ì¿ íŒ¡ì´ì¸ , ìƒˆë²½ë°°ì†¡ ì„œë¹„ìŠ¤ ëŸ°ì¹­... 24ì‹œê°„ ì£¼ë¬¸ ê°€ëŠ¥",
          keyword: "ì¿ íŒ¡ì´ì¸ ",
          source: "ì•„ì´ë‰´ìŠ¤24",
          tags: "#ìƒˆë²½ë°°ì†¡ #24ì‹œê°„ #ì„œë¹„ìŠ¤",
          url: "https://example.com/news6",
          date: "2025-07-29",
          summary: "ì¿ íŒ¡ì´ì¸ ê°€ ì‹ ì„ ì‹í’ˆ ìƒˆë²½ë°°ì†¡ ì„œë¹„ìŠ¤ë¥¼ ë„ì…í•˜ë©° 24ì‹œê°„ ì£¼ë¬¸ ì‹œìŠ¤í…œì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.",
          likes: 3,
          id: 5
        },
        {
          title: "ì•¼ë†€ì, í•´ì™¸ ì—¬í–‰ ì˜ˆì•½ ì„œë¹„ìŠ¤ ê°•í™”... ë™ë‚¨ì•„ í˜¸í…” 2ë§Œê°œ ì¶”ê°€",
          keyword: "ì•¼ë†€ì",
          source: "ë¹„ì¦ˆë‹ˆìŠ¤ì›Œì¹˜",
          tags: "#ì—¬í–‰ #í•´ì™¸ì˜ˆì•½ #í˜¸í…”",
          url: "https://example.com/news7",
          date: "2025-07-29",
          summary: "ì•¼ë†€ìê°€ ë™ë‚¨ì•„ì‹œì•„ ì§€ì—­ í˜¸í…” íŒŒíŠ¸ë„ˆì‹­ì„ ëŒ€í­ í™•ëŒ€í•˜ë©°, í•´ì™¸ ì—¬í–‰ ì‹œì¥ì—ì„œì˜ ê²½ìŸë ¥ì„ ê°•í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤.",
          likes: 9,
          id: 6
        },
      ];
      setNewsData(simulatedData);
      setError(`Google Sheets API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°ë¥¼ ëŒ€ì‹  í‘œì‹œí•©ë‹ˆë‹¤.`);
      
      // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°ì˜ ìµœì‹  ë‚ ì§œ ì¶”ì¶œ
      const latest = simulatedData.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date;
      setLatestDate(latest);

    } finally {
      setLoading(false);
    }
  };

  // Firestoreì—ì„œ ë¶ë§ˆí¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹¤ì‹œê°„ ë™ê¸°í™”)
  useEffect(() => {
    if (!db || !userId) return;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const bookmarksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/bookmarks`);
    const q = query(bookmarksCollectionRef);

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedBookmarks = new Set(snapshot.docs.map(doc => doc.data().newsId));
      setBookmarkedNewsIds(fetchedBookmarks);
    }, (error) => {
      console.error("ë¶ë§ˆí¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
      setError("ë¶ë§ˆí¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    });

    return () => unsubscribe();
  }, [db, userId]); // db ë˜ëŠ” userIdê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì‹¤í–‰

  // Firestoreì—ì„œ AI ì¸ì‚¬ì´íŠ¸ ë©”íŠ¸ë¦­ìŠ¤(íˆ¬í‘œìˆ˜) ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹¤ì‹œê°„ ë™ê¸°í™”)
  useEffect(() => {
    if (!db || newsData.length === 0 || !userId) return; 

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const metricsCollectionRef = collection(db, `artifacts/${appId}/public/data/aiInsightMetrics`);

    const unsubscribe = onSnapshot(metricsCollectionRef, async (snapshot) => {
      const fetched = {};
      snapshot.forEach(doc => {
        fetched[doc.id] = doc.data();
      });
      setAiInsightMetrics(fetched);

      // í˜„ì¬ newsDataì— ìˆëŠ” ëª¨ë“  ë‰´ìŠ¤ í•­ëª©ì— ëŒ€í•´ Firestoreì— ë©”íŠ¸ë¦­ìŠ¤ í•­ëª©ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ì´ˆê¸°í™”
      for (const news of newsData) {
        if (!fetched[news.id] && userId) { 
          try {
            await setDoc(doc(metricsCollectionRef, String(news.id)), { // setDocìœ¼ë¡œ ìˆ˜ì •
              upvotes: 0,
              downvotes: 0,
              newsId: news.id 
            }, { merge: true });
          } catch (e) {
            console.error(`ë‰´ìŠ¤ ID ${news.id}ì— ëŒ€í•œ AI ì¸ì‚¬ì´íŠ¸ ë©”íŠ¸ë¦­ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨:`, e);
          }
        }
      }
    }, (error) => {
      console.error("AI ì¸ì‚¬ì´íŠ¸ ë©”íŠ¸ë¦­ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
      setError("AI ì¸ì‚¬ì´íŠ¸ ë©”íŠ¸ë¦­ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    });

    return () => unsubscribe();
  }, [db, userId, newsData]); 

  // Firestoreì—ì„œ AI ì¸ì‚¬ì´íŠ¸ ëŒ“ê¸€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹¤ì‹œê°„ ë™ê¸°í™”)
  useEffect(() => {
    if (!db || !userId) return;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/aiInsightComments`);
    const q = query(commentsCollectionRef); 

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedComments = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setAiInsightComments(fetchedComments);
    }, (error) => {
      console.error("AI ì¸ì‚¬ì´íŠ¸ ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
      setError("AI ì¸ì‚¬ì´íŠ¸ ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    });

    return () => unsubscribe();
  }, [db, userId]);

  // ë‚ ì§œë³„ë¡œ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ê·¸ë£¹í™”í•˜ëŠ” í•¨ìˆ˜
  const groupNewsByDate = (data) => {
    return data.reduce((groups, news) => {
      const { date } = news;
      if (!groups[date]) {
        groups[date] = [];
      }
      groups[date].push(news);
      return groups;
    }, {});
  };

  // í™œì„± íƒ­ì— ë”°ë¼ ë‰´ìŠ¤ ë°ì´í„° í•„í„°ë§
  const filteredNewsData = activeTab === "recommended" 
    ? newsData.filter(news => news.tags.includes("ì¶”ì²œ"))
    : activeTab === "bookmarks"
      ? newsData.filter(news => bookmarkedNewsIds.has(news.id)) // ë¶ë§ˆí¬ëœ ë‰´ìŠ¤ë§Œ í•„í„°ë§
      : newsData;

  const groupedNewsByDate = groupNewsByDate(filteredNewsData);
  const sortedDates = Object.keys(groupedNewsByDate).sort((a, b) => new Date(b) - new Date(a));

  // 'ë” ë¶ˆëŸ¬ì˜¤ê¸°' ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (ê° ë‚ ì§œë³„ë¡œ ê´€ë¦¬)
  const [showMoreCounts, setShowMoreCounts] = useState({});
  const handleLoadMore = (date) => {
    setShowMoreCounts(prevCounts => ({
      ...prevCounts,
      [date]: (prevCounts[date] || 3) + 3 // ê¸°ë³¸ 3ê°œì”© ë” ë¶ˆëŸ¬ì˜¤ê¸°
    }));
  };

  // ì¢‹ì•„ìš” ê¸°ëŠ¥ (í˜„ì¬ UIì— ì¢‹ì•„ìš” ë²„íŠ¼ì€ ì—†ì§€ë§Œ, í•¨ìˆ˜ëŠ” ìœ ì§€)
  const handleLike = (id) => {
    setNewsData(prevNews =>
      prevNews.map(news =>
        news.id === id ? { ...news, likes: (news.likes || 0) + 1 } : news
      )
    );
  };

  // ë¶ë§ˆí¬ í† ê¸€ í•¸ë“¤ëŸ¬ (Firestoreì— ì €ì¥/ì‚­ì œ)
  const toggleBookmark = async (newsId) => {
    if (!db || !userId) {
      setError("ë¶ë§ˆí¬ë¥¼ ì¶”ê°€/ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ì ì¸ì¦ ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const bookmarkRef = collection(db, `artifacts/${appId}/users/${userId}/bookmarks`);

    try {
      if (bookmarkedNewsIds.has(newsId)) {
        // ë¶ë§ˆí¬ í•´ì œ
        const q = query(bookmarkRef, where("newsId", "==", newsId));
        const snapshot = await getDocs(q); 
        snapshot.forEach(async (document) => {
          await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/bookmarks`, document.id));
        });
      } else {
        // ë¶ë§ˆí¬ ì¶”ê°€
        await addDoc(bookmarkRef, {
          newsId: newsId,
          timestamp: new Date().toISOString(),
        });
      }
    } catch (e) {
      console.error("ë¶ë§ˆí¬ í† ê¸€ ì‹¤íŒ¨: ", e);
      setError("ë¶ë§ˆí¬ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  };

  // AI ì¸ì‚¬ì´íŠ¸ ê°€ì ¸ì˜¤ê¸° (Gemini API ì—°ë™)
  const fetchAiInsight = async (newsId, newsTitle) => {
    setLoadingInsight(prev => ({ ...prev, [newsId]: true }));
    setAiInsights(prev => ({ ...prev, [newsId]: "" })); // Clear previous insight

    const prompt = `"${newsTitle}" ê¸°ì‚¬ì˜ ì‹œì‚¬ì ì„ 3ì¤„ë¡œ ìš”ì•½í•˜ì—¬ ì œì•ˆí•´ì£¼ì„¸ìš”.`;
    let chatHistory = [];
    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

    const payload = { contents: chatHistory };
    const apiKey = GEMINI_API_KEY; // Use the provided Gemini API key
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    let retryCount = 0;
    const maxRetries = 3;
    const baseDelay = 1000; // 1 second

    while (retryCount < maxRetries) {
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          if (response.status === 429) { // Too Many Requests
            const delay = baseDelay * Math.pow(2, retryCount);
            console.warn(`Rate limit hit. Retrying in ${delay / 1000} seconds...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            retryCount++;
            continue; // Retry the request
          }
          const errorText = await response.text();
          throw new Error(`Gemini API ì˜¤ë¥˜: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
          const text = result.candidates[0].content.parts[0].text;
          setAiInsights(prev => ({ ...prev, [newsId]: text }));
          break; // Success, exit loop
        } else {
          setAiInsights(prev => ({ ...prev, [newsId]: "ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤." }));
        }
      } catch (e) {
        console.error("AI ì¸ì‚¬ì´íŠ¸ ìƒì„± ì‹¤íŒ¨:", e);
        setAiInsights(prev => ({ ...prev, [newsId]: `AI ì¸ì‚¬ì´íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}` }));
        break; // Exit loop on critical error
      } finally {
        setLoadingInsight(prev => ({ ...prev, [newsId]: false }));
      }
    }
  };

  // AI ì¸ì‚¬ì´íŠ¸ íˆ¬í‘œ í•¸ë“¤ëŸ¬ (Firestoreì— ì €ì¥)
  const handleAiInsightVote = async (newsId, type) => {
    if (!db || !userId) {
      setError("AI ì¸ì‚¬ì´íŠ¸ì— íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ì ì¸ì¦ ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const metricDocRef = doc(db, `artifacts/${appId}/public/data/aiInsightMetrics`, String(newsId));

    try {
      const docSnap = await getDoc(metricDocRef);
      if (docSnap.exists()) {
        const currentData = docSnap.data();
        const update = {};
        if (type === 'up') {
          update.upvotes = (currentData.upvotes || 0) + 1;
        } else if (type === 'down') {
          update.downvotes = (currentData.downvotes || 0) + 1;
        }
        await updateDoc(metricDocRef, update);
      } else {
        // ë©”íŠ¸ë¦­ìŠ¤ ë¬¸ì„œê°€ ì•„ì§ ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ìœ¼ë¡œ ìƒì„± (ì˜ˆì™¸ ìƒí™© ëŒ€ë¹„)
        await setDoc(metricDocRef, {
          newsId: newsId,
          upvotes: type === 'up' ? 1 : 0,
          downvotes: type === 'down' ? 1 : 0,
        }, { merge: true });
      }
    } catch (e) {
      console.error("AI ì¸ì‚¬ì´íŠ¸ íˆ¬í‘œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ", e);
      setError("AI ì¸ì‚¬ì´íŠ¸ íˆ¬í‘œë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  };

  // AI ëŒ€ëŒ“ê¸€ ìƒì„± í•¨ìˆ˜
  const generateAiRebuttal = async (newsId, humanCommentText, newsTitle) => {
    if (!db || !userId) {
      console.error("AI ëŒ€ëŒ“ê¸€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: DB ë˜ëŠ” userIdê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }

    setIsGeneratingAiReply(true); // AI ëŒ€ëŒ“ê¸€ ìƒì„± ì‹œì‘

    const prompt = `ë‰´ìŠ¤ ì œëª©: "${newsTitle}"
AI ì¸ì‚¬ì´íŠ¸ì— ëŒ€í•œ ì¸ê°„ ëŒ“ê¸€: "${humanCommentText}"

ì´ ì¸ê°„ ëŒ“ê¸€ì— ëŒ€í•´ AIë¡œì„œ ë‹¤ìŒ ì§€ì‹œì‚¬í•­ì— ë”°ë¼ ë‹µë³€í•´ì£¼ì„¸ìš”:
1. AIì˜ ìƒê° ê³¼ì •ì„ 1ì¤„ë¡œ ìš”ì•½í•˜ì—¬ í‘œí˜„í•´ì£¼ì„¸ìš”. (ì˜ˆ: "AIì˜ ìƒê°: ì¸ê°„ ëŒ“ê¸€ì„ ë¶„ì„í•˜ì—¬ í•µì‹¬ ë…¼ì ì„ íŒŒì•… ì¤‘ì…ë‹ˆë‹¤.")
2. ì¸ê°„ ëŒ“ê¸€ì— ëŒ€í•œ 1ì¤„ ë°˜ë°• ë…¼ë¦¬ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”.
3. ì´ ë°˜ë°• ë…¼ë¦¬ì— ëŒ€í•œ ê·¼ê±°ë¥¼ 2ì¤„ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”.

ë‹µë³€ í˜•ì‹:
[AIì˜ ìƒê°]
[1ì¤„ ë°˜ë°• ë…¼ë¦¬]
[ê·¼ê±°1]
[ê·¼ê±°2]`;
    let chatHistory = [];
    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

    const payload = { contents: chatHistory };
    const apiKey = GEMINI_API_KEY;
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    let retryCount = 0;
    const maxRetries = 3;
    const baseDelay = 1000;

    while (retryCount < maxRetries) {
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          if (response.status === 429) {
            const delay = baseDelay * Math.pow(2, retryCount);
            console.warn(`AI ëŒ€ëŒ“ê¸€: Rate limit hit. Retrying in ${delay / 1000} seconds...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            retryCount++;
            continue;
          }
          const errorText = await response.text();
          throw new Error(`AI ëŒ€ëŒ“ê¸€ Gemini API ì˜¤ë¥˜: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
          const rawText = result.candidates[0].content.parts[0].text;
          const lines = rawText.split('\n').filter(line => line.trim() !== ''); // ë¹ˆ ì¤„ ì œê±°
          
          let aiReplyText = "";
          if (lines.length >= 1) {
            aiReplyText += lines[0]; // AIì˜ ìƒê°
          }
          if (lines.length >= 2) {
            aiReplyText += "\n" + lines[1]; // 1ì¤„ ë°˜ë°• ë…¼ë¦¬
          }
          if (lines.length >= 3) {
            aiReplyText += "\n" + lines[2]; // ê·¼ê±°1
          }
          if (lines.length >= 4) {
            aiReplyText += "\n" + lines[3]; // ê·¼ê±°2
          }
          
          // AI ëŒ€ëŒ“ê¸€ì„ Firestoreì— ì¶”ê°€
          const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
          await addDoc(collection(db, `artifacts/${appId}/public/data/aiInsightComments`), {
            newsId: newsId,
            text: aiReplyText,
            timestamp: new Date().toISOString(),
            userId: "AI", // AIê°€ ì‘ì„±í•œ ëŒ“ê¸€ì„ì„ ë‚˜íƒ€ëƒ„
            role: "ai" // ì—­í•  í•„ë“œ ì¶”ê°€
          });
          break; // Success, exit loop
        } else {
          console.warn("AI ëŒ€ëŒ“ê¸€: ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.");
        }
      } catch (e) {
        console.error("AI ëŒ€ëŒ“ê¸€ ìƒì„± ì‹¤íŒ¨:", e);
        break; // Exit loop on critical error
      } finally {
        setIsGeneratingAiReply(false); // AI ëŒ€ëŒ“ê¸€ ìƒì„± ì™„ë£Œ
      }
    }
  };

  // AI ì¸ì‚¬ì´íŠ¸ ëŒ“ê¸€ ì¶”ê°€ í•¸ë“¤ëŸ¬ (Firestoreì— ì €ì¥ ë° AI ëŒ€ëŒ“ê¸€ íŠ¸ë¦¬ê±°)
  const handleAddAiInsightComment = async (newsId, commentText, newsTitle) => {
    if (commentText.trim() === "") return; // ë¹ˆ ëŒ“ê¸€ ë°©ì§€
    if (!db || !userId) {
      setError("AI ì¸ì‚¬ì´íŠ¸ì— ëŒ“ê¸€ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ì ì¸ì¦ ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    try {
      await addDoc(collection(db, `artifacts/${appId}/public/data/aiInsightComments`), {
        newsId: newsId,
        text: commentText,
        timestamp: new Date().toISOString(), // ISO Stringìœ¼ë¡œ ì €ì¥í•˜ì—¬ ì •ë ¬ ìš©ì´
        userId: userId, // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID
        role: "user" // ì—­í•  í•„ë“œ ì¶”ê°€
      });

      // ì¸ê°„ ëŒ“ê¸€ ì¶”ê°€ í›„ AI ëŒ€ëŒ“ê¸€ ìƒì„± íŠ¸ë¦¬ê±°
      generateAiRebuttal(newsId, commentText, newsTitle);

    } catch (e) {
      console.error("AI ì¸ì‚¬ì´íŠ¸ ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨: ", e);
      setError("AI ì¸ì‚¬ì´íŠ¸ ëŒ“ê¸€ì„ ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  };

  useEffect(() => {
    fetchNewsFromGoogleSheets();
  }, []);

  return (
    <div className="min-h-screen bg-white font-sans">
      <header className="sticky top-0 bg-white shadow-sm z-10">
        <div className="flex justify-between items-center px-4 py-3 border-b border-gray-200">
          <div className="flex items-center gap-2">
            <Newspaper className="text-blue-600 w-6 h-6" />
            <span className="text-xl font-bold text-gray-900">ì •ìì¼ë¡œ ë°ì¼ë¦¬ ë‰´ìŠ¤</span>
          </div>
          {latestDate && (
            <span className="text-gray-500 text-sm">
              ì—…ë°ì´íŠ¸: {latestDate}
            </span>
          )}
        </div>
        {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ (ì™¼ìª½ ì •ë ¬) */}
        <div className="flex justify-start border-b border-gray-200 bg-gray-50 px-4 sm:px-4">
          <button
            onClick={() => { setActiveTab("recommended"); setShowMoreCounts({}); }}
            className={`py-3 px-6 text-lg font-semibold ${
              activeTab === "recommended"
                ? "text-blue-600 border-b-2 border-blue-600"
                : "text-gray-600 hover:text-gray-800"
            }`}
          >
            ì¶”ì²œ ë‰´ìŠ¤
          </button>
          <button
            onClick={() => { setActiveTab("all"); setShowMoreCounts({}); }}
            className={`py-3 px-6 text-lg font-semibold ${
              activeTab === "all"
                ? "text-blue-600 border-b-2 border-blue-600"
                : "text-gray-600 hover:text-gray-800"
            }`}
          >
            ì „ì²´ ë‰´ìŠ¤
          </button>
          <button
            onClick={() => { setActiveTab("bookmarks"); setShowMoreCounts({}); }}
            className={`py-3 px-6 text-lg font-semibold ${
              activeTab === "bookmarks"
                ? "text-blue-600 border-b-2 border-blue-600"
                : "text-gray-600 hover:text-gray-800"
            }`}
          >
            ë¶ë§ˆí¬
          </button>
        </div>
      </header>

      <main className="py-4">
        {loading && (
          <div className="text-center text-gray-500 p-8">
            <div className="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
            <p>ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        )}
        {error && !loading && (
          <Alert variant="destructive" className="mx-4 sm:mx-8">
            <AlertTitle>ì•Œë¦¼</AlertTitle>
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}
        
        {sortedDates.length === 0 && !loading && !error && (
          <div className="text-center text-gray-500 p-8">
            <p>í‘œì‹œí•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        )}

        {sortedDates.map(date => (
          <div key={date} className="px-4 sm:px-4 mb-6">
            <div className="flex items-center gap-2 mb-3">
              <span className="text-gray-600 text-lg font-bold">
                {date}
              </span>
            </div>
            <div className="space-y-4">
              {groupedNewsByDate[date].slice(0, showMoreCounts[date] || 3).map((news, index) => (
                <Card key={news.id || index} className="p-4 bg-gray-50">
                  <div className="flex justify-between items-start">
                    <h3 className="text-xl font-bold text-gray-800 mb-1 flex-grow">
                      {news.title}
                    </h3>
                    {/* ë¶ë§ˆí¬ ì•„ì´ì½˜ */}
                    <button
                      onClick={() => toggleBookmark(news.id)}
                      className="ml-4 p-2 rounded-full hover:bg-gray-200 transition-colors"
                      aria-label="Toggle bookmark"
                    >
                      <Star 
                        size={24} 
                        className={bookmarkedNewsIds.has(news.id) ? "text-yellow-500 fill-current" : "text-gray-400"} 
                      />
                    </button>
                  </div>
                  <div className="text-gray-500 text-sm mb-2">
                    {news.date}
                  </div>
                  <p className="text-gray-700 text-base leading-relaxed mb-3">
                    {news.summary}
                  </p>
                  <div className="flex items-center gap-2 text-sm text-gray-600 mb-3">
                    <span className="bg-gray-200 px-2 py-1 rounded-full text-sm text-gray-600">{news.keyword}</span>
                    <span>{news.source}</span>
                  </div>
                  
                  {news.url && (
                    <a
                      href={news.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-1 text-blue-700 hover:text-blue-800 text-sm font-medium mb-4"
                    >
                      <ExternalLink size={16} />
                      ì›ë¬¸ ë³´ê¸°
                    </a>
                  )}

                  {/* AI ì¸ì‚¬ì´íŠ¸ ë²„íŠ¼ ë° í‘œì‹œ */}
                  <div className="mt-4 pt-4 border-t border-gray-200 flex flex-col items-end">
                    <button
                      onClick={() => fetchAiInsight(news.id, news.title)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm"
                      disabled={loadingInsight[news.id]}
                    >
                      {loadingInsight[news.id] ? 'AI ì¸ì‚¬ì´íŠ¸ ìƒì„± ì¤‘...' : 'âœ¨AI ì¸ì‚¬ì´íŠ¸'}
                    </button>
                    {aiInsights[news.id] && (
                      <div className="mt-2 p-3 bg-gray-50 rounded-md text-gray-800 text-sm w-full">
                        <p className="whitespace-pre-wrap">{aiInsights[news.id]}</p>
                        
                        {/* AI ì¸ì‚¬ì´íŠ¸ íˆ¬í‘œ */}
                        <div className="flex items-center gap-4 text-sm text-gray-600 mt-3 border-t pt-2 border-gray-200">
                          <span className="font-semibold">ì¸ì‚¬ì´íŠ¸ í‰ê°€:</span>
                          <div className="flex items-center gap-1">
                            <button onClick={() => handleAiInsightVote(news.id, 'up')} className="p-1 rounded-full hover:bg-gray-200">
                              <ThumbsUp size={16} className="text-green-600" />
                            </button>
                            <span>{aiInsightMetrics[news.id]?.upvotes || 0}</span>
                          </div>
                          <div className="flex items-center gap-1">
                            <button onClick={() => handleAiInsightVote(news.id, 'down')} className="p-1 rounded-full hover:bg-gray-200">
                              <ThumbsDown size={16} className="text-red-600" />
                            </button>
                            <span>{aiInsightMetrics[news.id]?.downvotes || 0}</span>
                          </div>
                        </div>

                        {/* AI ì¸ì‚¬ì´íŠ¸ ëŒ“ê¸€ ì„¹ì…˜ */}
                        <div className="mt-4 pt-4 border-t border-gray-200">
                          <h5 className="text-md font-semibold text-gray-700 mb-2">AI ì¸ì‚¬ì´íŠ¸ì— ëŒ€í•œ ì¸ê°„ì˜ ë°˜ë°•ğŸ’¬</h5> {/* ì œëª© ë³€ê²½ */}
                          <div className="space-y-2 mb-3">
                            {aiInsightComments
                              .filter(comment => comment.newsId === news.id)
                              .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                              .map((comment, commentIndex) => (
                                <div 
                                  key={comment.id || commentIndex} 
                                  className={`p-2 rounded-md text-sm ${comment.role === "ai" ? "bg-blue-50 text-blue-800 ml-4" : "bg-gray-100 text-gray-800"}`} 
                                >
                                  <p className="whitespace-pre-wrap">{comment.text}</p>
                                  <span className="text-xs text-gray-500">
                                    {comment.role === "ai" ? "AI" : comment.userId?.substring(0, 8) + "..."} - {new Date(comment.timestamp).toLocaleString()}
                                  </span>
                                </div>
                              ))
                            }
                            {aiInsightComments.filter(comment => comment.newsId === news.id).length === 0 && (
                              <p className="text-sm text-gray-500">ì•„ì§ ì¸ì‚¬ì´íŠ¸ì— ëŒ€í•œ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            )}
                          </div>
                          <div className="flex gap-2">
                            <input
                              type="text"
                              placeholder="ì¸ì‚¬ì´íŠ¸ì— ëŒ€í•œ ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                              className="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              id={`ai-insight-comment-input-${news.id}`} 
                              onKeyPress={(e) => {
                                if (e.key === 'Enter') {
                                  handleAddAiInsightComment(news.id, e.target.value, news.title); 
                                  e.target.value = ''; 
                                }
                              }}
                              disabled={isGeneratingAiReply} // AI ëŒ€ëŒ“ê¸€ ìƒì„± ì¤‘ì—ëŠ” ë¹„í™œì„±í™”
                            />
                            <button
                              onClick={() => {
                                const inputElement = document.getElementById(`ai-insight-comment-input-${news.id}`);
                                if (inputElement) {
                                  handleAddAiInsightComment(news.id, inputElement.value, news.title); 
                                  inputElement.value = ''; 
                                }
                              }}
                              className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                              disabled={isGeneratingAiReply} // AI ëŒ€ëŒ“ê¸€ ìƒì„± ì¤‘ì—ëŠ” ë¹„í™œì„±í™”
                            >
                              {isGeneratingAiReply ? 'AI ìƒê°ì¤‘...' : 'AIì—ê²Œ ë°˜ë°•'} {/* ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ */}
                            </button>
                          </div>
                        </div> {/* End of AI Insight Comment Section */}
                      </div>
                    )}
                  </div> {/* End of AI Insight Button and Display */}
                </Card>
              ))}
              {/* ë‚ ì§œë³„ ë” ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ */}
              {groupedNewsByDate[date].length > (showMoreCounts[date] || 3) && (
                <div className="text-center mt-4">
                  <button
                    onClick={() => handleLoadMore(date)}
                    className="px-6 py-2 bg-gray-200 text-gray-800 rounded-full font-semibold hover:bg-gray-300 transition-colors"
                  >
                    ë” ë¶ˆëŸ¬ì˜¤ê¸° ({groupedNewsByDate[date].length - (showMoreCounts[date] || 3)}ê°œ ë‚¨ìŒ)
                  </button>
                </div>
              )}
            </div>
          </div>
        ))}
      </main>
    </div>
  );
};

export default ITNewsApp;
