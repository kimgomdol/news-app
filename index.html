import React, { useState, useEffect } from "react";
import {
  ExternalLink,
  Newspaper,
  Star, // 북마크 아이콘
  RefreshCw,
  ThumbsUp, // UP 투표 아이콘
  ThumbsDown // DOWN 투표 아이콘
} from "lucide-react";

// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, query, where, onSnapshot, addDoc, deleteDoc, doc, getDocs } from 'firebase/firestore';

// NOTE: This is a placeholder component for shadcn-ui Alert.
const Alert = ({ variant, children }) => (
  <div className={`p-4 rounded-lg my-4 ${variant === 'destructive' ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-blue-100 text-blue-700 border border-blue-300'}`}>
    {children}
  </div>
);

const AlertTitle = ({ children }) => <h5 className="font-bold text-lg mb-1">{children}</h5>;
const AlertDescription = ({ children }) => <p className="text-sm">{children}</p>;

// NOTE: This is a placeholder component for shadcn-ui Card.
const Card = ({ children, className }) => (
  <div className={`bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200 ${className}`}>
    {children}
  </div>
);

const CardContent = ({ children }) => <div className="p-4">{children}</div>;

const ITNewsApp = () => {
  const [newsData, setNewsData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [latestDate, setLatestDate] = useState("");
  const [activeTab, setActiveTab] = useState("recommended"); 
  
  // Firebase States
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [bookmarkedNewsIds, setBookmarkedNewsIds] = useState(new Set()); // 북마크된 뉴스 ID 집합

  // New states for AI insights votes and comments
  const [aiInsights, setAiInsights] = useState({}); // { newsId: "insight text" }
  const [loadingInsight, setLoadingInsight] = useState({}); // { newsId: boolean }
  const [aiInsightMetrics, setAiInsightMetrics] = useState({}); // { newsId: { upvotes: number, downvotes: number } }
  const [aiInsightComments, setAiInsightComments] = useState([]); // All AI insight comments from Firestore

  // State to manage AI rebuttal generation loading
  const [isGeneratingAiReply, setIsGeneratingAiReply] = useState(false);

  // Google Sheets 설정 (사용자 제공 값)
  const SHEET_ID = "1UFE_q1cuaa4WrgATcO6MlvZOgq1zKkU_IAHrJzxPU7U";
  const SHEET_NAME = "news";
  const API_KEY = "AIzaSyDIig_uUt8grXOehM3JyI_sabFBh3EuTS8"; // 사용자 제공 API 키

  // Gemini API 키 (사용자 제공 값)
  const GEMINI_API_KEY = "AIzaSyDIig_uUt8grXOehM3JyI_sabFBh3EuTS8";
  
  // Firebase 초기화 및 인증
  useEffect(() => {
    // Canvas 환경에서 전역 변수 사용
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const authInstance = getAuth(app);

      setDb(firestore);
      setAuth(authInstance);

      // 인증 상태 변경 리스너
      const unsubscribeAuth = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          // __initial_auth_token이 있으면 커스텀 토큰으로 로그인, 없으면 익명 로그인
          if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(authInstance, __initial_auth_token);
          } else {
            await signInAnonymously(authInstance);
          }
          setUserId(authInstance.currentUser?.uid || crypto.randomUUID()); // 익명 로그인 후 userId 설정
        }
      });

      return () => unsubscribeAuth(); // 클린업
    } catch (e) {
      console.error("Firebase 초기화 또는 인증 실패:", e);
      setError("앱 초기화 중 오류가 발생했습니다.");
    }
  }, []); // 컴포넌트 마운트 시 한 번만 실행

  // Google Sheets에서 데이터 가져오기
  const fetchNewsFromGoogleSheets = async () => {
    setLoading(true);
    setError("");
    
    try {
      if (!API_KEY || API_KEY === "YOUR_GOOGLE_SHEETS_API_KEY") { 
        console.log("API 키가 설정되지 않아 시뮬레이션 데이터를 사용합니다.");
        throw new Error("Google Sheets API 키가 설정되지 않았거나 유효하지 않습니다.");
      }
      
      const encodedSheetName = encodeURIComponent(SHEET_NAME);
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodedSheetName}?key=${API_KEY}`;
      
      const response = await fetch(url);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Google Sheets API 오류: ${response.status} - ${errorText}`);
      }
      
      const data = await response.json();
      const rows = data.values;
      
      if (!rows || rows.length === 0) {
        throw new Error("Google Sheets에서 데이터를 찾을 수 없습니다.");
      }
      
      // 첫 번째 행은 헤더이므로 제외
      const headers = rows[0];
      const dataRows = rows.slice(1);
      
      // 데이터 파싱 (기사제목-키워드-언론사-태그-기사URL-날짜-요약-좋아요)
      const parsedNews = dataRows.map((row, index) => ({
        title: row[0] || "",
        keyword: row[1] || "",
        source: row[2] || "",
        tags: row[3] || "", // 태그 정보
        url: row[4] || "",
        date: row[5] || "", // 날짜 정보
        summary: row[6] || "", // 요약 정보
        likes: parseInt(row[7]) || 0, // 좋아요 수가 있다면
        id: index // 고유 ID
      })).filter(news => news.title && news.keyword); // 빈 데이터 필터링
      
      setNewsData(parsedNews);
      
      // 가장 최신 날짜를 추출
      if (parsedNews.length > 0) {
        const latest = parsedNews.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date;
        setLatestDate(latest);
      }
      
    } catch (err) {
      console.error("Google Sheets 데이터 가져오기 실패:", err);
      
      // 오류 발생 시 시뮬레이션 데이터 사용
      const simulatedData = [
        {
          title: "네이버, AI 검색 서비스 대폭 개선... 정확도 30% 향상",
          keyword: "네이버",
          source: "IT조선",
          tags: "#AI #검색 #기술혁신 #추천", // '추천' 태그 추가
          url: "https://example.com/news1",
          date: "2025-08-01",
          summary: "네이버가 자체 개발한 AI 기술을 적용하여 검색 정확도를 크게 개선했으며, 사용자 만족도가 크게 향상될 것으로 예상됩니다.",
          likes: 12,
          id: 0
        },
        {
          title: "토스, 투자 플랫폼 '토스증권' 월 거래액 10조원 돌파",
          keyword: "토스",
          source: "매일경제",
          tags: "#핀테크 #투자 #거래액",
          url: "https://example.com/news2",
          date: "2025-07-31",
          summary: "토스증권이 월 거래액 10조원을 돌파하며 핀테크 시장의 새로운 강자로 떠올랐습니다.",
          likes: 8,
          id: 1
        },
        {
          title: "당근마켓, 지역 상권 활성화 프로젝트 시작... 소상공인 지원",
          keyword: "당근마켓",
          source: "한국경제",
          tags: "#지역상권 #소상공인 #지원사업 #추천", // '추천' 태그 추가
          url: "https://example.com/news3",
          date: "2025-07-31",
          summary: "당근마켓이 지역 소상공인을 위한 종합 지원 프로그램을 런칭하며, 온오프라인 연계 서비스를 통해 지역경제 활성화에 나섰습니다.",
          likes: 15,
          id: 2
        },
        {
          title: "쿠팡, 물류 로봇 도입으로 배송 속도 20% 단축",
          keyword: "쿠팡",
          source: "디지털타임스",
          tags: "#물류 #로봇 #배송",
          url: "https://example.com/news4",
          date: "2025-07-30",
          summary: "쿠팡이 물류센터에 첨단 로봇을 도입하여 배송 처리 속도를 획기적으로 개선했습니다.",
          likes: 6,
          id: 3
        },
        {
          title: "배민, 배달료 무료 서비스 확대... 전국 주요 도시로 확장",
          keyword: "배민",
          source: "전자신문",
          tags: "#배달 #무료서비스 #확장 #추천", // '추천' 태그 추가
          url: "https://example.com/news5",
          date: "2025-07-30",
          summary: "배달의민족이 배달료 무료 서비스를 전국 주요 도시로 확대하며, 소비자 부담을 줄이고 시장 점유율 확대에 나섰습니다.",
          likes: 20,
          id: 4
        },
        {
          title: "쿠팡이츠, 새벽배송 서비스 런칭... 24시간 주문 가능",
          keyword: "쿠팡이츠",
          source: "아이뉴스24",
          tags: "#새벽배송 #24시간 #서비스",
          url: "https://example.com/news6",
          date: "2025-07-29",
          summary: "쿠팡이츠가 신선식품 새벽배송 서비스를 도입하며 24시간 주문 시스템을 구축했습니다.",
          likes: 3,
          id: 5
        },
        {
          title: "야놀자, 해외 여행 예약 서비스 강화... 동남아 호텔 2만개 추가",
          keyword: "야놀자",
          source: "비즈니스워치",
          tags: "#여행 #해외예약 #호텔",
          url: "https://example.com/news7",
          date: "2025-07-29",
          summary: "야놀자가 동남아시아 지역 호텔 파트너십을 대폭 확대하며, 해외 여행 시장에서의 경쟁력을 강화하고 있습니다.",
          likes: 9,
          id: 6
        },
      ];
      setNewsData(simulatedData);
      setError(`Google Sheets API 키가 설정되지 않았거나 유효하지 않습니다. 시뮬레이션 데이터를 대신 표시합니다.`);
      
      // 시뮬레이션 데이터의 최신 날짜 추출
      const latest = simulatedData.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date;
      setLatestDate(latest);

    } finally {
      setLoading(false);
    }
  };

  // Firestore에서 북마크 데이터 가져오기 (실시간 동기화)
  useEffect(() => {
    if (!db || !userId) return;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const bookmarksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/bookmarks`);
    const q = query(bookmarksCollectionRef);

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedBookmarks = new Set(snapshot.docs.map(doc => doc.data().newsId));
      setBookmarkedNewsIds(fetchedBookmarks);
    }, (error) => {
      console.error("북마크를 불러오는 데 실패했습니다:", error);
      setError("북마크를 불러오는 데 실패했습니다.");
    });

    return () => unsubscribe();
  }, [db, userId]); // db 또는 userId가 변경될 때마다 실행

  // Firestore에서 AI 인사이트 메트릭스(투표수) 데이터 가져오기 (실시간 동기화)
  useEffect(() => {
    if (!db || newsData.length === 0 || !userId) return; 

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const metricsCollectionRef = collection(db, `artifacts/${appId}/public/data/aiInsightMetrics`);

    const unsubscribe = onSnapshot(metricsCollectionRef, async (snapshot) => {
      const fetched = {};
      snapshot.forEach(doc => {
        fetched[doc.id] = doc.data();
      });
      setAiInsightMetrics(fetched);

      // 현재 newsData에 있는 모든 뉴스 항목에 대해 Firestore에 메트릭스 항목이 있는지 확인하고 없으면 초기화
      for (const news of newsData) {
        if (!fetched[news.id] && userId) { 
          try {
            await setDoc(doc(metricsCollectionRef, String(news.id)), { // setDoc으로 수정
              upvotes: 0,
              downvotes: 0,
              newsId: news.id 
            }, { merge: true });
          } catch (e) {
            console.error(`뉴스 ID ${news.id}에 대한 AI 인사이트 메트릭스 초기화 실패:`, e);
          }
        }
      }
    }, (error) => {
      console.error("AI 인사이트 메트릭스를 불러오는 데 실패했습니다:", error);
      setError("AI 인사이트 메트릭스를 불러오는 데 실패했습니다.");
    });

    return () => unsubscribe();
  }, [db, userId, newsData]); 

  // Firestore에서 AI 인사이트 댓글 데이터 가져오기 (실시간 동기화)
  useEffect(() => {
    if (!db || !userId) return;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/aiInsightComments`);
    const q = query(commentsCollectionRef); 

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedComments = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setAiInsightComments(fetchedComments);
    }, (error) => {
      console.error("AI 인사이트 댓글을 불러오는 데 실패했습니다:", error);
      setError("AI 인사이트 댓글을 불러오는 데 실패했습니다.");
    });

    return () => unsubscribe();
  }, [db, userId]);

  // 날짜별로 뉴스 데이터를 그룹화하는 함수
  const groupNewsByDate = (data) => {
    return data.reduce((groups, news) => {
      const { date } = news;
      if (!groups[date]) {
        groups[date] = [];
      }
      groups[date].push(news);
      return groups;
    }, {});
  };

  // 활성 탭에 따라 뉴스 데이터 필터링
  const filteredNewsData = activeTab === "recommended" 
    ? newsData.filter(news => news.tags.includes("추천"))
    : activeTab === "bookmarks"
      ? newsData.filter(news => bookmarkedNewsIds.has(news.id)) // 북마크된 뉴스만 필터링
      : newsData;

  const groupedNewsByDate = groupNewsByDate(filteredNewsData);
  const sortedDates = Object.keys(groupedNewsByDate).sort((a, b) => new Date(b) - new Date(a));

  // '더 불러오기' 버튼 클릭 핸들러 (각 날짜별로 관리)
  const [showMoreCounts, setShowMoreCounts] = useState({});
  const handleLoadMore = (date) => {
    setShowMoreCounts(prevCounts => ({
      ...prevCounts,
      [date]: (prevCounts[date] || 3) + 3 // 기본 3개씩 더 불러오기
    }));
  };

  // 좋아요 기능 (현재 UI에 좋아요 버튼은 없지만, 함수는 유지)
  const handleLike = (id) => {
    setNewsData(prevNews =>
      prevNews.map(news =>
        news.id === id ? { ...news, likes: (news.likes || 0) + 1 } : news
      )
    );
  };

  // 북마크 토글 핸들러 (Firestore에 저장/삭제)
  const toggleBookmark = async (newsId) => {
    if (!db || !userId) {
      setError("북마크를 추가/삭제할 수 없습니다. 사용자 인증 또는 데이터베이스 연결에 문제가 있습니다.");
      return;
    }

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const bookmarkRef = collection(db, `artifacts/${appId}/users/${userId}/bookmarks`);

    try {
      if (bookmarkedNewsIds.has(newsId)) {
        // 북마크 해제
        const q = query(bookmarkRef, where("newsId", "==", newsId));
        const snapshot = await getDocs(q); 
        snapshot.forEach(async (document) => {
          await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/bookmarks`, document.id));
        });
      } else {
        // 북마크 추가
        await addDoc(bookmarkRef, {
          newsId: newsId,
          timestamp: new Date().toISOString(),
        });
      }
    } catch (e) {
      console.error("북마크 토글 실패: ", e);
      setError("북마크를 처리하는 데 실패했습니다.");
    }
  };

  // AI 인사이트 가져오기 (Gemini API 연동)
  const fetchAiInsight = async (newsId, newsTitle) => {
    setLoadingInsight(prev => ({ ...prev, [newsId]: true }));
    setAiInsights(prev => ({ ...prev, [newsId]: "" })); // Clear previous insight

    const prompt = `"${newsTitle}" 기사의 시사점을 3줄로 요약하여 제안해주세요.`;
    let chatHistory = [];
    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

    const payload = { contents: chatHistory };
    const apiKey = GEMINI_API_KEY; // Use the provided Gemini API key
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    let retryCount = 0;
    const maxRetries = 3;
    const baseDelay = 1000; // 1 second

    while (retryCount < maxRetries) {
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          if (response.status === 429) { // Too Many Requests
            const delay = baseDelay * Math.pow(2, retryCount);
            console.warn(`Rate limit hit. Retrying in ${delay / 1000} seconds...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            retryCount++;
            continue; // Retry the request
          }
          const errorText = await response.text();
          throw new Error(`Gemini API 오류: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
          const text = result.candidates[0].content.parts[0].text;
          setAiInsights(prev => ({ ...prev, [newsId]: text }));
          break; // Success, exit loop
        } else {
          setAiInsights(prev => ({ ...prev, [newsId]: "인사이트를 생성할 수 없습니다. 응답 구조가 예상과 다릅니다." }));
        }
      } catch (e) {
        console.error("AI 인사이트 생성 실패:", e);
        setAiInsights(prev => ({ ...prev, [newsId]: `AI 인사이트 생성 중 오류 발생: ${e.message}` }));
        break; // Exit loop on critical error
      } finally {
        setLoadingInsight(prev => ({ ...prev, [newsId]: false }));
      }
    }
  };

  // AI 인사이트 투표 핸들러 (Firestore에 저장)
  const handleAiInsightVote = async (newsId, type) => {
    if (!db || !userId) {
      setError("AI 인사이트에 투표할 수 없습니다. 사용자 인증 또는 데이터베이스 연결에 문제가 있습니다.");
      return;
    }

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const metricDocRef = doc(db, `artifacts/${appId}/public/data/aiInsightMetrics`, String(newsId));

    try {
      const docSnap = await getDoc(metricDocRef);
      if (docSnap.exists()) {
        const currentData = docSnap.data();
        const update = {};
        if (type === 'up') {
          update.upvotes = (currentData.upvotes || 0) + 1;
        } else if (type === 'down') {
          update.downvotes = (currentData.downvotes || 0) + 1;
        }
        await updateDoc(metricDocRef, update);
      } else {
        // 메트릭스 문서가 아직 없으면 초기값으로 생성 (예외 상황 대비)
        await setDoc(metricDocRef, {
          newsId: newsId,
          upvotes: type === 'up' ? 1 : 0,
          downvotes: type === 'down' ? 1 : 0,
        }, { merge: true });
      }
    } catch (e) {
      console.error("AI 인사이트 투표 업데이트 실패: ", e);
      setError("AI 인사이트 투표를 업데이트하는 데 실패했습니다.");
    }
  };

  // AI 대댓글 생성 함수
  const generateAiRebuttal = async (newsId, humanCommentText, newsTitle) => {
    if (!db || !userId) {
      console.error("AI 대댓글을 생성할 수 없습니다: DB 또는 userId가 준비되지 않았습니다.");
      return;
    }

    setIsGeneratingAiReply(true); // AI 대댓글 생성 시작

    const prompt = `뉴스 제목: "${newsTitle}"
AI 인사이트에 대한 인간 댓글: "${humanCommentText}"

이 인간 댓글에 대해 AI로서 다음 지시사항에 따라 답변해주세요:
1. AI의 생각 과정을 1줄로 요약하여 표현해주세요. (예: "AI의 생각: 인간 댓글을 분석하여 핵심 논점을 파악 중입니다.")
2. 인간 댓글에 대한 1줄 반박 논리를 제시해주세요.
3. 이 반박 논리에 대한 근거를 2줄로 설명해주세요.

답변 형식:
[AI의 생각]
[1줄 반박 논리]
[근거1]
[근거2]`;
    let chatHistory = [];
    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

    const payload = { contents: chatHistory };
    const apiKey = GEMINI_API_KEY;
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    let retryCount = 0;
    const maxRetries = 3;
    const baseDelay = 1000;

    while (retryCount < maxRetries) {
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          if (response.status === 429) {
            const delay = baseDelay * Math.pow(2, retryCount);
            console.warn(`AI 대댓글: Rate limit hit. Retrying in ${delay / 1000} seconds...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            retryCount++;
            continue;
          }
          const errorText = await response.text();
          throw new Error(`AI 대댓글 Gemini API 오류: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
          const rawText = result.candidates[0].content.parts[0].text;
          const lines = rawText.split('\n').filter(line => line.trim() !== ''); // 빈 줄 제거
          
          let aiReplyText = "";
          if (lines.length >= 1) {
            aiReplyText += lines[0]; // AI의 생각
          }
          if (lines.length >= 2) {
            aiReplyText += "\n" + lines[1]; // 1줄 반박 논리
          }
          if (lines.length >= 3) {
            aiReplyText += "\n" + lines[2]; // 근거1
          }
          if (lines.length >= 4) {
            aiReplyText += "\n" + lines[3]; // 근거2
          }
          
          // AI 대댓글을 Firestore에 추가
          const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
          await addDoc(collection(db, `artifacts/${appId}/public/data/aiInsightComments`), {
            newsId: newsId,
            text: aiReplyText,
            timestamp: new Date().toISOString(),
            userId: "AI", // AI가 작성한 댓글임을 나타냄
            role: "ai" // 역할 필드 추가
          });
          break; // Success, exit loop
        } else {
          console.warn("AI 대댓글: 응답 구조가 예상과 다릅니다.");
        }
      } catch (e) {
        console.error("AI 대댓글 생성 실패:", e);
        break; // Exit loop on critical error
      } finally {
        setIsGeneratingAiReply(false); // AI 대댓글 생성 완료
      }
    }
  };

  // AI 인사이트 댓글 추가 핸들러 (Firestore에 저장 및 AI 대댓글 트리거)
  const handleAddAiInsightComment = async (newsId, commentText, newsTitle) => {
    if (commentText.trim() === "") return; // 빈 댓글 방지
    if (!db || !userId) {
      setError("AI 인사이트에 댓글을 추가할 수 없습니다. 사용자 인증 또는 데이터베이스 연결에 문제가 있습니다.");
      return;
    }

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    try {
      await addDoc(collection(db, `artifacts/${appId}/public/data/aiInsightComments`), {
        newsId: newsId,
        text: commentText,
        timestamp: new Date().toISOString(), // ISO String으로 저장하여 정렬 용이
        userId: userId, // 현재 로그인된 사용자 ID
        role: "user" // 역할 필드 추가
      });

      // 인간 댓글 추가 후 AI 대댓글 생성 트리거
      generateAiRebuttal(newsId, commentText, newsTitle);

    } catch (e) {
      console.error("AI 인사이트 댓글 저장 실패: ", e);
      setError("AI 인사이트 댓글을 저장하는 데 실패했습니다.");
    }
  };

  useEffect(() => {
    fetchNewsFromGoogleSheets();
  }, []);

  return (
    <div className="min-h-screen bg-white font-sans">
      <header className="sticky top-0 bg-white shadow-sm z-10">
        <div className="flex justify-between items-center px-4 py-3 border-b border-gray-200">
          <div className="flex items-center gap-2">
            <Newspaper className="text-blue-600 w-6 h-6" />
            <span className="text-xl font-bold text-gray-900">정자일로 데일리 뉴스</span>
          </div>
          {latestDate && (
            <span className="text-gray-500 text-sm">
              업데이트: {latestDate}
            </span>
          )}
        </div>
        {/* 탭 네비게이션 (왼쪽 정렬) */}
        <div className="flex justify-start border-b border-gray-200 bg-gray-50 px-4 sm:px-4">
          <button
            onClick={() => { setActiveTab("recommended"); setShowMoreCounts({}); }}
            className={`py-3 px-6 text-lg font-semibold ${
              activeTab === "recommended"
                ? "text-blue-600 border-b-2 border-blue-600"
                : "text-gray-600 hover:text-gray-800"
            }`}
          >
            추천 뉴스
          </button>
          <button
            onClick={() => { setActiveTab("all"); setShowMoreCounts({}); }}
            className={`py-3 px-6 text-lg font-semibold ${
              activeTab === "all"
                ? "text-blue-600 border-b-2 border-blue-600"
                : "text-gray-600 hover:text-gray-800"
            }`}
          >
            전체 뉴스
          </button>
          <button
            onClick={() => { setActiveTab("bookmarks"); setShowMoreCounts({}); }}
            className={`py-3 px-6 text-lg font-semibold ${
              activeTab === "bookmarks"
                ? "text-blue-600 border-b-2 border-blue-600"
                : "text-gray-600 hover:text-gray-800"
            }`}
          >
            북마크
          </button>
        </div>
      </header>

      <main className="py-4">
        {loading && (
          <div className="text-center text-gray-500 p-8">
            <div className="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
            <p>뉴스 데이터를 불러오는 중...</p>
          </div>
        )}
        {error && !loading && (
          <Alert variant="destructive" className="mx-4 sm:mx-8">
            <AlertTitle>알림</AlertTitle>
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}
        
        {sortedDates.length === 0 && !loading && !error && (
          <div className="text-center text-gray-500 p-8">
            <p>표시할 뉴스가 없습니다.</p>
          </div>
        )}

        {sortedDates.map(date => (
          <div key={date} className="px-4 sm:px-4 mb-6">
            <div className="flex items-center gap-2 mb-3">
              <span className="text-gray-600 text-lg font-bold">
                {date}
              </span>
            </div>
            <div className="space-y-4">
              {groupedNewsByDate[date].slice(0, showMoreCounts[date] || 3).map((news, index) => (
                <Card key={news.id || index} className="p-4 bg-gray-50">
                  <div className="flex justify-between items-start">
                    <h3 className="text-xl font-bold text-gray-800 mb-1 flex-grow">
                      {news.title}
                    </h3>
                    {/* 북마크 아이콘 */}
                    <button
                      onClick={() => toggleBookmark(news.id)}
                      className="ml-4 p-2 rounded-full hover:bg-gray-200 transition-colors"
                      aria-label="Toggle bookmark"
                    >
                      <Star 
                        size={24} 
                        className={bookmarkedNewsIds.has(news.id) ? "text-yellow-500 fill-current" : "text-gray-400"} 
                      />
                    </button>
                  </div>
                  <div className="text-gray-500 text-sm mb-2">
                    {news.date}
                  </div>
                  <p className="text-gray-700 text-base leading-relaxed mb-3">
                    {news.summary}
                  </p>
                  <div className="flex items-center gap-2 text-sm text-gray-600 mb-3">
                    <span className="bg-gray-200 px-2 py-1 rounded-full text-sm text-gray-600">{news.keyword}</span>
                    <span>{news.source}</span>
                  </div>
                  
                  {news.url && (
                    <a
                      href={news.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-1 text-blue-700 hover:text-blue-800 text-sm font-medium mb-4"
                    >
                      <ExternalLink size={16} />
                      원문 보기
                    </a>
                  )}

                  {/* AI 인사이트 버튼 및 표시 */}
                  <div className="mt-4 pt-4 border-t border-gray-200 flex flex-col items-end">
                    <button
                      onClick={() => fetchAiInsight(news.id, news.title)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm"
                      disabled={loadingInsight[news.id]}
                    >
                      {loadingInsight[news.id] ? 'AI 인사이트 생성 중...' : '✨AI 인사이트'}
                    </button>
                    {aiInsights[news.id] && (
                      <div className="mt-2 p-3 bg-gray-50 rounded-md text-gray-800 text-sm w-full">
                        <p className="whitespace-pre-wrap">{aiInsights[news.id]}</p>
                        
                        {/* AI 인사이트 투표 */}
                        <div className="flex items-center gap-4 text-sm text-gray-600 mt-3 border-t pt-2 border-gray-200">
                          <span className="font-semibold">인사이트 평가:</span>
                          <div className="flex items-center gap-1">
                            <button onClick={() => handleAiInsightVote(news.id, 'up')} className="p-1 rounded-full hover:bg-gray-200">
                              <ThumbsUp size={16} className="text-green-600" />
                            </button>
                            <span>{aiInsightMetrics[news.id]?.upvotes || 0}</span>
                          </div>
                          <div className="flex items-center gap-1">
                            <button onClick={() => handleAiInsightVote(news.id, 'down')} className="p-1 rounded-full hover:bg-gray-200">
                              <ThumbsDown size={16} className="text-red-600" />
                            </button>
                            <span>{aiInsightMetrics[news.id]?.downvotes || 0}</span>
                          </div>
                        </div>

                        {/* AI 인사이트 댓글 섹션 */}
                        <div className="mt-4 pt-4 border-t border-gray-200">
                          <h5 className="text-md font-semibold text-gray-700 mb-2">AI 인사이트에 대한 인간의 반박💬</h5> {/* 제목 변경 */}
                          <div className="space-y-2 mb-3">
                            {aiInsightComments
                              .filter(comment => comment.newsId === news.id)
                              .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                              .map((comment, commentIndex) => (
                                <div 
                                  key={comment.id || commentIndex} 
                                  className={`p-2 rounded-md text-sm ${comment.role === "ai" ? "bg-blue-50 text-blue-800 ml-4" : "bg-gray-100 text-gray-800"}`} 
                                >
                                  <p className="whitespace-pre-wrap">{comment.text}</p>
                                  <span className="text-xs text-gray-500">
                                    {comment.role === "ai" ? "AI" : comment.userId?.substring(0, 8) + "..."} - {new Date(comment.timestamp).toLocaleString()}
                                  </span>
                                </div>
                              ))
                            }
                            {aiInsightComments.filter(comment => comment.newsId === news.id).length === 0 && (
                              <p className="text-sm text-gray-500">아직 인사이트에 대한 댓글이 없습니다.</p>
                            )}
                          </div>
                          <div className="flex gap-2">
                            <input
                              type="text"
                              placeholder="인사이트에 대한 댓글을 입력하세요..."
                              className="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              id={`ai-insight-comment-input-${news.id}`} 
                              onKeyPress={(e) => {
                                if (e.key === 'Enter') {
                                  handleAddAiInsightComment(news.id, e.target.value, news.title); 
                                  e.target.value = ''; 
                                }
                              }}
                              disabled={isGeneratingAiReply} // AI 대댓글 생성 중에는 비활성화
                            />
                            <button
                              onClick={() => {
                                const inputElement = document.getElementById(`ai-insight-comment-input-${news.id}`);
                                if (inputElement) {
                                  handleAddAiInsightComment(news.id, inputElement.value, news.title); 
                                  inputElement.value = ''; 
                                }
                              }}
                              className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                              disabled={isGeneratingAiReply} // AI 대댓글 생성 중에는 비활성화
                            >
                              {isGeneratingAiReply ? 'AI 생각중...' : 'AI에게 반박'} {/* 버튼 텍스트 변경 */}
                            </button>
                          </div>
                        </div> {/* End of AI Insight Comment Section */}
                      </div>
                    )}
                  </div> {/* End of AI Insight Button and Display */}
                </Card>
              ))}
              {/* 날짜별 더 불러오기 버튼 */}
              {groupedNewsByDate[date].length > (showMoreCounts[date] || 3) && (
                <div className="text-center mt-4">
                  <button
                    onClick={() => handleLoadMore(date)}
                    className="px-6 py-2 bg-gray-200 text-gray-800 rounded-full font-semibold hover:bg-gray-300 transition-colors"
                  >
                    더 불러오기 ({groupedNewsByDate[date].length - (showMoreCounts[date] || 3)}개 남음)
                  </button>
                </div>
              )}
            </div>
          </div>
        ))}
      </main>
    </div>
  );
};

export default ITNewsApp;
